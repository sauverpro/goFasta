<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GoFasta - Terminal Mockup</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f7f8; /* soft background */
      --panel:#ffffff;
      --accent:#17a589; /* teal/green */
      --accent-2:#10b981;
      --muted:#9aa6aa;
      --dark:#0f1724;
      --card-shadow: 0 6px 18px rgba(15,23,36,0.06);
    }
    *{box-sizing:border-box}
    body{font-family: 'Montserrat', sans-serif; margin:0; background:linear-gradient(180deg,#eef4f5 0%,var(--bg) 100%); color:var(--dark)}

    .terminal{
      max-width:1100px;
      margin:28px auto;
      padding:28px;
      background:linear-gradient(180deg,#ffffff 0%, #f7fbfc 100%);
      border-radius:8px;
      box-shadow: 0 8px 30px rgba(13,20,25,0.08);
      border-top:6px solid #edf2f3;
    }

    /* header */
    .header{display:flex; align-items:center; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:14px}
    .logo{
      width:58px; height:58px; background:var(--accent-2); border-radius:10px; display:flex; align-items:center; justify-content:center; color:#fff; box-shadow:0 6px 14px rgba(16,185,129,0.12);
    }
    .logo svg{width:26px;height:26px;opacity:0.95}
    .brand h1{margin:0;font-size:20px; font-weight:800}
    .brand p{margin:0;color:var(--muted);font-size:13px}

    .clock{
      background: #ffffff; border-radius:8px; padding:10px 18px; display:flex; align-items:center; gap:10px; box-shadow:var(--card-shadow);
      border:1px solid #f1f5f6;
    }
    .clock .time{font-weight:800; font-size:30px; letter-spacing:1px}
    .clock .amp{color:var(--muted); font-weight:700}

    /* content */
    .section{margin-top:26px}
    .section-header{display:flex; align-items:center; justify-content:space-between}
    .section-header h2{margin:0;font-size:18px}
    .badge{background:#e9fbf4;color:var(--accent-2);padding:6px 10px;border-radius:8px;font-weight:700;font-size:13px}

    /* cards */
    .cards{display:flex; gap:18px;margin-top:16px}
    .card{background:var(--panel); border-radius:12px; padding:18px; flex:1; box-shadow:var(--card-shadow); border:1px solid #f2f6f7}
    .card .top{display:flex;align-items:center;gap:12px}
    .mini-logo{width:50px;height:50px;background:var(--accent-2);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff}
    .mini-logo svg{width:24px;height:24px}
    .title{font-weight:700;font-size:16px}
    .sub{color:var(--muted);font-size:12px}

    .eta{display:flex;align-items:center;gap:12px;margin-top:16px}
    .eta-circle{width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;flex-direction:column}
    .eta-small{font-size:11px;color:var(--muted);margin-top:2px}

    .occ{margin-top:10px}
    .occ-bar{height:12px;border-radius:10px;background:#f1f5f6;overflow:hidden}
    .occ-fill{height:100%; border-radius:10px}
    .occ-row{display:flex;align-items:center;justify-content:space-between;margin-top:8px}

    /* bottom icons */
    .bottom-icons{display:flex;gap:16px; justify-content:center; margin-top:28px}
    .icon-square{width:72px;height:72px;border-radius:12px;background:#0b1320;display:flex;align-items:center;justify-content:center;color:#cbd6db; box-shadow: 0 6px 18px rgba(11,19,32,0.06)}

    /* responsiveness */
    @media (max-width:860px){
      .cards{flex-direction:column}
      .bottom-icons{flex-wrap:wrap}
      .icon-square{width:60px;height:60px}
    }

  </style>
</head>
<body>
  <div class="terminal">
    <div class="header">
      <div class="brand">
        <div class="logo" aria-hidden>
          <!-- small bus icon -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="4" width="20" height="12" rx="2" fill="white" opacity="0.12"/><path d="M3 10v3a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-3" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 10v3a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1v-3" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div>
          <h1>GoFasta</h1>
          <p>Predictive ride</p>
        </div>
      </div>

      <div class="clock" id="clock">
        <div class="time" id="time">12:00</div>
        <div class="amp">Am</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>Available Buses</h2>
        <div class="badge">5 Buses</div>
      </div>

      <div class="cards">
        <!-- Card 1 -->
        <div class="card">
          <div class="top">
            <div class="mini-logo">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M3 10h18v4H3z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div>
              <div class="title">RAK B88M</div>
              <div class="sub">Remera to Nyabugogo</div>
            </div>
          </div>

          <div class="eta">
            <div class="eta-circle" style="background:#eaf8f0;color:var(--accent-2)">5 min</div>
            <div>
              <div class="eta-small">ETA</div>
              <div style="height:18px"></div>
            </div>
          </div>

          <div class="occ">
            <div class="occ-row">
              <div class="sub">Occupancy Rate</div>
              <div class="sub">60%</div>
            </div>
            <div class="occ-bar">
              <div class="occ-fill" style="width:60%; background:linear-gradient(90deg,#f59e0b,#f97316);"></div>
            </div>
          </div>
        </div>

        <!-- Card 2 -->
        <div class="card">
          <div class="top">
            <div class="mini-logo" style="background:#f3faf9;color:var(--accent-2);">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M3 10h18v4H3z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div>
              <div class="title">RAK B88M</div>
              <div class="sub">Remera to Nyabugogo</div>
            </div>
          </div>

          <div class="eta">
            <div class="eta-circle" style="background:#fff0f1;color:#ef4444">5 min</div>
            <div>
              <div class="eta-small">ETA</div>
            </div>
          </div>

          <div class="occ">
            <div class="occ-row">
              <div class="sub">Occupancy Rate</div>
              <div class="sub">60%</div>
            </div>
            <div class="occ-bar">
              <div class="occ-fill" style="width:60%; background:linear-gradient(90deg,#10b981,#06b6d4);"></div>
            </div>
          </div>
        </div>

        <!-- Card 3 -->
        <div class="card">
          <div class="top">
            <div class="mini-logo" style="background:#fef6ec;color:#f59e0b">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M3 10h18v4H3z" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div>
              <div class="title">RAK B88M</div>
              <div class="sub">Remera to Nyabugogo</div>
            </div>
          </div>

          <div class="eta">
            <div class="eta-circle" style="background:#fff7ec;color:#f97316">5 min</div>
            <div>
              <div class="eta-small">ETA</div>
            </div>
          </div>

          <div class="occ">
            <div class="occ-row">
              <div class="sub">Occupancy Rate</div>
              <div class="sub">60%</div>
            </div>
            <div class="occ-bar">
              <div class="occ-fill" style="width:60%; background:linear-gradient(90deg,#ef4444,#f43f5e);"></div>
            </div>
          </div>
        </div>

      </div>

      <div class="bottom-icons">
        <div class="icon-square">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 12h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        </div>
        <div class="icon-square">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6"/></svg>
        </div>
        <div class="icon-square">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 3v18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        </div>
        <div class="icon-square">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M4 12h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        </div>
        <div class="icon-square">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.6"/></svg>
        </div>
      </div>

    </div>
  </div>

 <!-- Socket.IO Client Library -->
 <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

 <script>
const SERVER_URL = 'https://server3-4gb1.onrender.com';

// Store devices data
let devicesData = [];

// Convert ETA seconds into readable time
function formatEta(seconds) {
  if (seconds == null) return '--';
  const mins = Math.round(seconds / 60);
  if (mins < 1) return '1 min';
  return `${mins} min`;
}

// Update UI with devices data
function updateDevicesUI() {
  const container = document.querySelector('.cards');
  const badge = document.querySelector('.badge');
  
  badge.textContent = `${devicesData.length} Buses`;
  container.innerHTML = ''; // Clear old cards

  // Color schemes for different buses
  const colorSchemes = [
    { etaBg: '#eaf8f0', etaColor: '#10b981', barGradient: 'linear-gradient(90deg,#f59e0b,#f97316)' },
    { etaBg: '#fff0f1', etaColor: '#ef4444', barGradient: 'linear-gradient(90deg,#10b981,#06b6d4)' },
    { etaBg: '#fff7ec', etaColor: '#f97316', barGradient: 'linear-gradient(90deg,#ef4444,#f43f5e)' },
    { etaBg: '#ede9fe', etaColor: '#8b5cf6', barGradient: 'linear-gradient(90deg,#8b5cf6,#a855f7)' },
    { etaBg: '#fef3c7', etaColor: '#f59e0b', barGradient: 'linear-gradient(90deg,#eab308,#f59e0b)' }
  ];

  devicesData.forEach((bus, i) => {
    const etaSec = bus.etaSeconds || bus.eta;
    const occPercent = 60 + (i * 5); // fake occupancy for display
    const colors = colorSchemes[i % colorSchemes.length];

    // Create each bus card dynamically
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="top">
        <div class="mini-logo">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="4" width="20" height="12" rx="2" fill="white" opacity="0.12"/>
            <path d="M3 10v3a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-3" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 10v3a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1v-3" stroke="white" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <div class="title">${bus.plate_number || bus.device_id || bus.busId || 'RAK B88M'}</div>
          <div class="sub">Remera to Nyabugogo</div>
        </div>
      </div>

      <div class="eta">
        <div class="eta-circle" style="background:${colors.etaBg}; color:${colors.etaColor};">
          <div>${formatEta(etaSec)}</div>
          <div class="eta-small">ETA</div>
        </div>
      </div>

      <div class="occ">
        <div class="occ-row">
          <div class="sub">Occupancy Rate</div>
          <div class="sub">${occPercent}%</div>
        </div>
        <div class="occ-bar">
          <div class="occ-fill" style="width:${occPercent}%; background:${colors.barGradient};"></div>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

// Update individual bus from route-update event
function updateBusFromPayload(payload) {
  const index = devicesData.findIndex(d => 
    d.device_id === payload.busId || 
    d.busId === payload.busId ||
    d.plate_number === payload.busId
  );
  
  if (index !== -1) {
    devicesData[index] = {
      ...devicesData[index],
      busId: payload.busId,
      etaSeconds: payload.eta,
      eta: payload.eta,
      currentPosition: payload.currentPosition,
      last_lat: payload.currentPosition?.lat,
      last_lon: payload.currentPosition?.lon
    };
  } else {
    // Add new bus if not found
    devicesData.push({
      busId: payload.busId,
      device_id: payload.busId,
      etaSeconds: payload.eta,
      eta: payload.eta,
      currentPosition: payload.currentPosition,
      last_lat: payload.currentPosition?.lat,
      last_lon: payload.currentPosition?.lon
    });
  }
  
  updateDevicesUI();
}

// Handle devices snapshot
function handleDevicesSnapshot(snapshot) {
  if (snapshot?.devices) {
    devicesData = snapshot.devices;
    updateDevicesUI();
  }
}

// Initialize Socket.IO connection
const socket = io(SERVER_URL, {
  transports: ["websocket"],
  reconnection: true
});

socket.on("connect", () => {
  console.log("âœ… Connected to server:", SERVER_URL);
  console.log("Socket ID:", socket.id);
  console.log("ðŸ“¡ Listening for ALL events from server...");
  
  // Try multiple common ways to request data from the server
  console.log("ðŸ“¤ Attempting to request data from server...");
  
  // Common request patterns
  socket.emit("get-devices");
  socket.emit("getDevices");
  socket.emit("request-data");
  socket.emit("subscribe");
  socket.emit("subscribe-devices");
  socket.emit("join", "devices");
  socket.emit("devices:get");
  socket.emit("fetch-devices");
  socket.emit("route-update");
  
  console.log("âœ… Sent multiple data request events to server");
  
  // Request initial data after connection
  setTimeout(() => {
    console.log("â° 5 seconds passed, checking for data...");
    console.log(devicesData);
    
    if (devicesData.length === 0) {
      console.log("âš ï¸ No data received yet.");
      console.log("ðŸ’¡ The server may not be sending data or may require authentication");
      console.log("ðŸ’¡ Check the Network tab to see if the WebSocket connection is active");
      console.log("ðŸ’¡ You may need to check the server's documentation for the correct event names");
    } else {
      console.log(`âœ… Received data for ${devicesData.length} device(s)`);
    }
  }, 5000);
});

socket.on("route-update", (payload) => {
  console.log("=== ROUTE UPDATE RECEIVED ===");
  console.log("Full payload:", JSON.stringify(payload, null, 2));
  console.log(`Bus ID: ${payload.busId}`);
  console.log(`ETA: ${payload.eta}`);
  console.log(`Position:`, payload.currentPosition);
  console.log("============================");
  updateBusFromPayload(payload);
});

socket.on("devices-snapshot", (snapshot) => {
  console.log("=== DEVICES SNAPSHOT RECEIVED ===");
  console.log("Full snapshot:", JSON.stringify(snapshot, null, 2));
  if (snapshot?.devices) {
    console.log(`âœ… Number of devices: ${snapshot.devices.length}`);
    snapshot.devices.forEach((device, i) => {
      console.log(`Device ${i + 1}:`, device);
    });
    handleDevicesSnapshot(snapshot);
  } else {
    console.log("âš ï¸ Snapshot received but no devices array found");
  }
  console.log("=================================");
});

socket.on("disconnect", () => {
  console.log("âŒ Disconnected from server");
});

socket.on("error", (error) => {
  console.error("Socket error:", error);
});

// Log connection state
console.log("ðŸš€ Initializing Socket.IO connection to:", SERVER_URL);
console.log("Current devices data:", devicesData);

// IMPORTANT: Listen to ALL events from the server to debug what's being sent
socket.onAny((eventName, ...args) => {
  console.log(`ðŸ”” [Event Received] "${eventName}"`);
  console.log("ðŸ“¦ Data:", args);
  console.log("ðŸ“¦ Stringified:", JSON.stringify(args, null, 2));
  console.log("---");
  
  // Try to handle any event that might contain device/bus data
  if (args[0]) {
    const data = args[0];
    
    // Check if it's an array of devices
    if (Array.isArray(data)) {
      console.log("ðŸšŒ Detected array of devices, updating UI...");
      devicesData = data;
      updateDevicesUI();
    }
    // Check if it has a devices property
    else if (data.devices && Array.isArray(data.devices)) {
      console.log("ðŸšŒ Detected devices array in object, updating UI...");
      devicesData = data.devices;
      updateDevicesUI();
    }
    // Check if it's a single bus update
    else if (data.busId || data.device_id || data.id) {
      console.log("ðŸšŒ Detected single bus update, updating UI...");
      updateBusFromPayload(data);
    }
  }
});

// Live clock
function updateClock() {
  const now = new Date();
  let hours = now.getHours();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  if (hours === 0) hours = 12;
  const minutes = String(now.getMinutes()).padStart(2, '0');
  document.getElementById('time').textContent = `${hours}:${minutes}`;
  document.querySelector('.clock .amp').textContent = ampm;
}
updateClock();
setInterval(updateClock, 1000);
</script>


</body>
</html>
