<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GoFasta - Terminal Mockup</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f7f8;
      --panel:#ffffff;
      --accent:#17a589;
      --accent-2:#10b981;
      --muted:#9aa6aa;
      --dark:#0f1724;
      --card-shadow: 0 6px 18px rgba(15,23,36,0.06);
      --online: #10b981;
      --offline: #94a3b8;
      --moving: #3b82f6;
      --stopped: #ef4444;
    }
    *{box-sizing:border-box}
    body{
      font-family: 'Montserrat', sans-serif; 
      margin:0; 
      background: var(--bg); 
      color:var(--dark);
      min-height: 100vh;
    }

    /* Main container with horizontal layout */
    .container {
      display: flex;
      min-height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      gap: 20px;
    }

    /* Left sidebar - GoFasta info */
    .sidebar {
      width: 280px;
      background: var(--panel);
      border-radius: 12px;
      padding: 30px 20px;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
    }

    .brand {
      text-align: center;
      margin-bottom: 40px;
    }

    .logo {
      width: 70px;
      height: 70px;
      background: var(--accent-2);
      border-radius: 12px;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo svg {
      width: 32px;
      height: 32px;
      opacity: 0.95;
    }

    .brand h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 800;
      color: var(--dark);
    }

    .brand .subtitle {
      margin: 5px 0 0;
      color: var(--muted);
      font-size: 14px;
      font-weight: 400;
    }

    /* Connection status */
    .connection-status {
      background: #f8fafc;
      border-radius: 10px;
      padding: 12px 15px;
      margin-top: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid #f1f5f9;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #10b981;
    }

    .status-dot.connected { background: #10b981; }
    .status-dot.disconnected { background: #ef4444; }
    .status-dot.connecting { 
      background: #f59e0b;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--dark);
    }

    /* Main content area */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Top header with clock */
    .top-header {
      background: var(--panel);
      border-radius: 12px;
      padding: 20px 30px;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
      color: var(--dark);
    }

    .badge {
      background: #e9fbf4;
      color: var(--accent-2);
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
    }

    .clock {
      font-weight: 800;
      font-size: 32px;
      letter-spacing: 1px;
      color: var(--dark);
      text-align: right;
    }

    .clock .amp {
      font-size: 16px;
      color: var(--muted);
      font-weight: 600;
      margin-left: 5px;
    }

    /* Bus cards grid */
    .bus-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .bus-card {
      background: var(--panel);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid #f1f5f9;
      transition: transform 0.2s ease;
    }

    .bus-card:hover {
      transform: translateY(-2px);
    }

    .bus-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .bus-icon {
      width: 50px;
      height: 50px;
      background: var(--accent-2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bus-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .bus-info h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--dark);
    }

    .bus-info p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 12px;
    }

    /* Status indicators row */
    .status-indicators {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-badge.online {
      background: rgba(16, 185, 129, 0.1);
      color: var(--online);
    }

    .status-badge.offline {
      background: rgba(148, 163, 184, 0.1);
      color: var(--offline);
    }

    .status-badge.moving {
      background: rgba(59, 130, 246, 0.1);
      color: var(--moving);
    }

    .status-badge.stopped {
      background: rgba(239, 68, 68, 0.1);
      color: var(--stopped);
    }

    .status-icon {
      font-size: 10px;
    }

    /* ETA section */
    .eta-section {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 10px;
    }

    .eta-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 16px;
      background: #eaf8f0;
      color: var(--accent-2);
      flex-shrink: 0;
    }

    .eta-circle.offline {
      background: #f1f5f9;
      color: var(--muted);
    }

    .eta-small {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      font-weight: 600;
    }

    .eta-details {
      flex: 1;
    }

    .eta-message {
      color: var(--dark);
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
      line-height: 1.3;
    }

    .eta-subtext {
      color: var(--muted);
      font-size: 11px;
    }

    /* Stats row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat-item {
      text-align: center;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 2px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--muted);
      font-weight: 600;
    }

    .stat-subtext {
      font-size: 9px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Occupancy bar */
    .occupancy {
      margin-top: 15px;
    }

    .occupancy-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .occupancy-label {
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
    }

    .occupancy-percentage {
      color: var(--dark);
      font-size: 12px;
      font-weight: 700;
    }

    .occupancy-bar {
      height: 12px;
      background: #f1f5f6;
      border-radius: 6px;
      overflow: hidden;
    }

    .occupancy-fill {
      height: 100%;
      border-radius: 6px;
      background: linear-gradient(90deg, #f59e0b, #f97316);
      transition: width 0.5s ease;
    }

    /* Additional info */
    .additional-info {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #f1f5f6;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .last-update {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .coordinates {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Control buttons */
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: auto;
      padding-top: 20px;
    }

    .control-btn {
      width: 60px;
      height: 60px;
      background: #0b1320;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #cbd6db;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .control-btn:hover {
      transform: scale(1.05);
      background: #1e293b;
    }

    .control-btn svg {
      width: 24px;
      height: 24px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: var(--panel);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin: 0 0 10px;
      color: var(--dark);
      font-weight: 700;
    }

    .empty-state p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    /* Responsive design */
    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
        padding: 10px;
      }
      
      .sidebar {
        width: 100%;
      }
      
      .bus-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .bus-grid {
        grid-template-columns: 1fr;
      }
      
      .top-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .clock {
        text-align: center;
      }
      
      .controls {
        flex-wrap: wrap;
      }
      
      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .additional-info {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="4" width="20" height="12" rx="2" fill="white" opacity="0.12"/>
            <path d="M3 10v3a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-3" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20 10v3a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1v-3" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h1>GoFasta</h1>
        <p class="subtitle">Predictive ride</p>
      </div>

      <div class="connection-status">
        <span class="status-dot connecting"></span>
        <span class="status-text" id="statusText">Connecting...</span>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Header -->
      <div class="top-header">
        <div>
          <h2>Available Buses</h2>
        </div>
        <div class="badge" id="busCount">0 Buses</div>
        <div class="clock">
          <span id="time">12:00</span>
          <span class="amp" id="ampm">Am</span>
        </div>
      </div>

      <!-- Bus Cards Grid -->
      <div class="bus-grid" id="busGrid">
        <!-- Cards will be dynamically inserted here -->
      </div>

      <!-- Controls -->
      <div class="controls">
        <button class="control-btn" onclick="refreshData()" title="Refresh">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
          </svg>
        </button>
        <button class="control-btn" onclick="connectSocket()" title="Reconnect">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 5V1L7 6L12 11V7C15.31 7 18 9.69 18 13C18 16.31 15.31 19 12 19C8.69 19 6 16.31 6 13H4C4 17.42 7.58 21 12 21C16.42 21 20 17.42 20 13C20 8.58 16.42 5 12 5Z" fill="currentColor"/>
          </svg>
        </button>
        <button class="control-btn" onclick="showMockData()" title="Demo Data">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z" fill="currentColor"/>
          </svg>
        </button>
        <button class="control-btn" onclick="clearData()" title="Clear">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Socket.IO Client Library -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script>
  const SERVER_URL = 'https://server3-4gb1.onrender.com';
  
  let devicesData = [];
  let socket = null;
  let isConnected = false;

  // Update clock
  function updateClock() {
    const now = new Date();
    let hours = now.getHours();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    if (hours === 0) hours = 12;
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('time').textContent = `${hours}:${minutes}`;
    document.getElementById('ampm').textContent = ampm;
  }

  // Update connection status
  function updateConnectionStatus(status) {
    const dot = document.querySelector('.status-dot');
    const text = document.getElementById('statusText');
    
    dot.className = 'status-dot ' + status;
    
    switch(status) {
      case 'connected':
        text.textContent = 'Connected';
        isConnected = true;
        break;
      case 'disconnected':
        text.textContent = 'Disconnected';
        isConnected = false;
        break;
      case 'connecting':
        text.textContent = 'Connecting...';
        isConnected = false;
        break;
    }
  }

  // Format ETA
  function formatEta(seconds) {
    if (seconds == null || seconds === 0) return '--';
    const mins = Math.round(seconds / 60);
    if (mins < 1) return '1 min';
    return `${mins} min`;
  }

  // Format time ago from minutes
  function formatTimeFromMinutes(minutes) {
    if (!minutes || minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes} min ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    const days = Math.floor(hours / 24);
    return `${days} day${days > 1 ? 's' : ''} ago`;
  }

  // Generate color scheme for bus cards
  function getBusColorScheme(index) {
    const schemes = [
      { etaBg: '#eaf8f0', etaColor: '#10b981', barGradient: 'linear-gradient(90deg,#f59e0b,#f97316)' },
      { etaBg: '#fff0f1', etaColor: '#ef4444', barGradient: 'linear-gradient(90deg,#10b981,#06b6d4)' },
      { etaBg: '#fff7ec', etaColor: '#f97316', barGradient: 'linear-gradient(90deg,#ef4444,#f43f5e)' },
      { etaBg: '#ede9fe', etaColor: '#8b5cf6', barGradient: 'linear-gradient(90deg,#8b5cf6,#a855f7)' },
      { etaBg: '#fef3c7', etaColor: '#f59e0b', barGradient: 'linear-gradient(90deg,#eab308,#f59e0b)' }
    ];
    return schemes[index % schemes.length];
  }

  // Update bus cards UI
  function updateBusCards() {
    const grid = document.getElementById('busGrid');
    const busCount = document.getElementById('busCount');
    
    busCount.textContent = `${devicesData.length} Bus${devicesData.length !== 1 ? 'es' : ''}`;
    
    if (devicesData.length === 0) {
      grid.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üöå</div>
          <h3>No Buses Available</h3>
          <p>Waiting for bus data to load...</p>
        </div>
      `;
      return;
    }
    
    grid.innerHTML = '';
    
    devicesData.forEach((bus, index) => {
      const busId = bus.busId || bus.device_id || bus.id || `BUS${index + 1}`;
      const plateNumber = bus.plateNumber || bus.plate_number || busId;
      const etaSeconds = bus.eta || bus.etaSeconds;
      const occupancyRate = bus.occupancyRate || bus.occupancy || 0;
      const route = bus.route || bus.destination || 'Remera to Nyabugogo';
      const speed = bus.speed || 0;
      const position = bus.currentPosition || {};
      const lastUpdate = bus.lastUpdate || bus.timestamp || '';
      const etaMessage = bus.etaMessage || bus.etaMessage || '';
      const isMoving = bus.isMoving;
      const etaStatus = bus.etaStatus || 'online';
      
      const colors = getBusColorScheme(index);
      
      // Determine status badges
      const statusBadges = [];
      
      if (etaStatus === 'offline') {
        statusBadges.push('<span class="status-badge offline"><span class="status-icon">‚óè</span> Offline</span>');
      } else {
        statusBadges.push('<span class="status-badge online"><span class="status-icon">‚óè</span> Online</span>');
      }
      
      if (isMoving === true) {
        statusBadges.push('<span class="status-badge moving"><span class="status-icon">‚ñ∂</span> Moving</span>');
      } else if (isMoving === false) {
        statusBadges.push('<span class="status-badge stopped"><span class="status-icon">‚è∏</span> Stopped</span>');
      }
      
      // Format last update time
      let formattedLastUpdate = '';
      if (lastUpdate) {
        try {
          const updateDate = new Date(lastUpdate);
          if (!isNaN(updateDate)) {
            formattedLastUpdate = updateDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          }
        } catch (e) {
          console.log('Error formatting date:', e);
        }
      }
      
      // Extract time ago from etaMessage if it contains minutes
      let timeAgoText = '';
      if (etaMessage && etaMessage.includes('min ago')) {
        const match = etaMessage.match(/(\d+)\s*min ago/);
        if (match) {
          const minutes = parseInt(match[1]);
          timeAgoText = formatTimeFromMinutes(minutes);
        }
      }
      
      const card = document.createElement('div');
      card.className = 'bus-card';
      card.innerHTML = `
        <div class="bus-header">
          <div class="bus-icon">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="4" width="20" height="12" rx="2" fill="white" opacity="0.12"/>
              <path d="M3 10v3a1 1 0 0 0 1 1h1a1 1 0 0 0 1-1v-3" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M20 10v3a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1v-3" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="bus-info">
            <h3>${plateNumber}</h3>
            <p>${route}</p>
          </div>
        </div>
        
        ${statusBadges.length > 0 ? `
          <div class="status-indicators">
            ${statusBadges.join('')}
          </div>
        ` : ''}
        
        <div class="eta-section">
          <div class="eta-circle ${etaStatus === 'offline' ? 'offline' : ''}" 
               style="${etaStatus !== 'offline' ? `background: ${colors.etaBg}; color: ${colors.etaColor};` : ''}">
            <div>${formatEta(etaSeconds)}</div>
            <div class="eta-small">ETA</div>
          </div>
          <div class="eta-details">
            <div class="eta-message">${etaMessage || 'Waiting for real-time data...'}</div>
            <div class="eta-subtext">${etaStatus === 'offline' ? 
              (timeAgoText || 'Last known position') : 
              'Live tracking active'}</div>
          </div>
        </div>
        
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-value">${Math.round(speed)}</div>
            <div class="stat-label">SPEED</div>
            <div class="stat-subtext">km/h</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${Math.round(etaSeconds / 60) || '--'}</div>
            <div class="stat-label">MINUTES</div>
            <div class="stat-subtext">to arrival</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${busId}</div>
            <div class="stat-label">BUS ID</div>
            <div class="stat-subtext">Vehicle ID</div>
          </div>
        </div>
        
        <div class="occupancy">
          <div class="occupancy-header">
            <span class="occupancy-label">Occupancy Rate</span>
            <span class="occupancy-percentage">${occupancyRate}%</span>
          </div>
          <div class="occupancy-bar">
            <div class="occupancy-fill" style="width: ${Math.min(occupancyRate, 100)}%; background: ${colors.barGradient};"></div>
          </div>
        </div>
        
        <div class="additional-info">
          <div class="last-update">
            <span>üïê</span>
            <span>${formattedLastUpdate ? `Updated: ${formattedLastUpdate}` : 'Waiting for update...'}</span>
          </div>
          ${position.lat && position.lng ? `
            <div class="coordinates">
              <span>üìå</span>
              <span>${position.lat.toFixed(4)}, ${position.lng.toFixed(4)}</span>
            </div>
          ` : ''}
        </div>
      `;
      
      grid.appendChild(card);
    });
  }

  // Handle bus data updates - FIXED VERSION
  function updateBusFromPayload(payload) {
    if (!payload) return;
    
    console.log('Received payload:', payload);
    
    const busId = payload.busId || payload.device_id || payload.id;
    if (!busId) {
      console.error('No busId found in payload:', payload);
      return;
    }
    
    const index = devicesData.findIndex(d => 
      d.busId === busId || 
      d.device_id === busId ||
      d.id === busId
    );
    
    // Map all fields - handles both route-update and snapshot formats
    const updatedBus = {
      busId: busId,
      plateNumber: payload.plateNumber || payload.plate_number || busId,
      occupancyRate: payload.occupancyRate || payload.occupancy || Math.floor(Math.random() * 40) + 60,
      eta: payload.eta,
      etaSeconds: payload.etaSeconds || payload.eta || 0,
      etaMessage: payload.etaMessage || 'Live tracking active',
      etaStatus: payload.etaStatus || 'normal',
      isMoving: payload.isMoving !== undefined ? payload.isMoving : (payload.last_speed > 5),
      currentPosition: payload.currentPosition || {
        lat: payload.last_lat,
        lng: payload.last_lon
      },
      destination: payload.destination,
      route: payload.route,
      speed: payload.speed || payload.last_speed || 0,
      timestamp: payload.timestamp,
      lastUpdate: payload.lastUpdate || payload.last_update || new Date().toISOString()
    };

    console.log(`Processing bus ${busId}:`, updatedBus);
    
    if (index !== -1) {
      devicesData[index] = updatedBus;
    } else {
      devicesData.push(updatedBus);
    }
    
    console.log(`‚úÖ Updated bus ${busId}, etaMessage: "${updatedBus.etaMessage}", total buses: ${devicesData.length}`);
    updateBusCards();
  }

  // Handle devices snapshot - normalize all devices through the same mapping
  function handleDevicesSnapshot(snapshot) {
    console.log('Received snapshot:', snapshot);
    let devices = [];
    
    if (snapshot?.devices && Array.isArray(snapshot.devices)) {
      devices = snapshot.devices;
    } else if (Array.isArray(snapshot)) {
      devices = snapshot;
    }
    
    // Clear existing data and process each device through the same normalization
    devicesData = [];
    devices.forEach(device => {
      updateBusFromPayload(device);
    });
  }

  // Initialize Socket.IO connection
  function connectSocket() {
    updateConnectionStatus('connecting');
    
    if (socket) {
      socket.disconnect();
    }

    socket = io(SERVER_URL, {
      transports: ["websocket"],
      reconnection: true,
      reconnectionDelay: 1000,
      timeout: 20000
    });

    socket.on("connect", () => {
      console.log('‚úÖ Connected to WebSocket server');
      updateConnectionStatus('connected');
      
      // Request initial data
      const events = ['get-devices', 'getDevices', 'subscribe'];
      events.forEach(event => socket.emit(event));
    });

    socket.on("route-update", (payload) => {
      console.log('üì° Received route-update event:', payload);
      updateBusFromPayload(payload);
    });

    socket.on("devices-snapshot", (snapshot) => {
      console.log('üì° Received devices-snapshot event:', snapshot);
      handleDevicesSnapshot(snapshot);
    });

    socket.on("disconnect", () => {
      console.log('‚ùå Disconnected from WebSocket server');
      updateConnectionStatus('disconnected');
    });

    socket.on("connect_error", (error) => {
      console.error('‚ùå Connection error:', error);
      updateConnectionStatus('disconnected');
    });

    // Listen to all events
    socket.onAny((eventName, data) => {
      console.log(`üîî Event: ${eventName}`, data);
      
      if (Array.isArray(data)) {
        devicesData = data;
        updateBusCards();
      } else if (data?.devices && Array.isArray(data.devices)) {
        devicesData = data.devices;
        updateBusCards();
      } else if (data?.busId || data?.device_id || data?.id) {
        updateBusFromPayload(data);
      }
    });
  }

  // Refresh data
  function refreshData() {
    if (socket && isConnected) {
      socket.emit('get-devices');
    } else {
      connectSocket();
    }
  }

  // Show mock data with realistic fields
  function showMockData() {
    devicesData = [
      {
        busId: '223',
        plateNumber: 'RAJ129P',
        occupancyRate: 68,
        eta: null,
        etaSeconds: 0,
        etaMessage: "Offline. Last data 34561 min ago.",
        etaStatus: "offline",
        isMoving: false,
        speed: 0,
        currentPosition: { lat: -1.979242, lng: 30.097363 },
        lastUpdate: "2025-12-15T11:58:31.725Z"
      },
      {
        busId: '123',
        plateNumber: 'RAJ123T',
        occupancyRate: 56,
        eta: 62280, // 1038 minutes
        etaSeconds: 62280,
        etaMessage: "Waiting for real-time data...",
        etaStatus: "online",
        isMoving: false,
        speed: 0,
        currentPosition: { lat: -1.979242, lng: 30.097363 },
        lastUpdate: new Date().toISOString()
      }
    ];
    updateBusCards();
  }

  // Clear data
  function clearData() {
    devicesData = [];
    updateBusCards();
  }

  // Initialize the app
  function initialize() {
    updateClock();
    setInterval(updateClock, 1000);
    
    // Start with empty state - real data will populate when available
    updateBusCards();
    
    // Connect to WebSocket
    connectSocket();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshData, 30000);
  }

  // Start the application
  initialize();
  </script>
</body>
</html>